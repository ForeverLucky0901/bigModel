# 上线安全检查清单

部署到生产环境前，请逐项检查以下内容：

## 🔐 密钥与凭证安全

- [ ] **加密密钥已生成**：`ENCRYPTION_KEY` 使用 `openssl rand -hex 32` 生成，至少32字节
- [ ] **数据库密码足够强**：`POSTGRES_PASSWORD` 使用强密码（至少16字符，包含大小写字母、数字、特殊字符）
- [ ] **Redis密码已设置**：生产环境必须设置 `REDIS_PASSWORD`
- [ ] **上游API Key已加密存储**：确认上游Key在数据库中为加密状态
- [ ] **环境变量文件已保护**：`.env` 文件权限为 600，不在版本控制中
- [ ] **SSL证书已配置**：HTTPS已启用，证书有效且未过期

## 🛡️ 访问控制

- [ ] **API Key鉴权已启用**：所有 `/v1/chat/completions` 请求必须包含有效的 Authorization header
- [ ] **管理员Key已安全保存**：管理员API Key已备份到安全位置
- [ ] **默认用户已禁用**：删除或禁用所有测试用户
- [ ] **用户权限已检查**：确认普通用户无管理员权限

## 🚦 限流与防护

- [ ] **限流规则已配置**：`RATE_LIMIT_RPM`、`RATE_LIMIT_TPM` 已根据业务需求设置
- [ ] **IP限流已启用**：`RATE_LIMIT_IP_RPM`、`RATE_LIMIT_IP_TPM` 已配置
- [ ] **Redis限流正常工作**：测试限流功能，确认超限请求被正确拒绝
- [ ] **配额检查已启用**：用户配额检查在每次请求前执行

## 📊 监控与日志

- [ ] **审计日志已启用**：所有API请求已记录到 `usage_records` 表
- [ ] **敏感信息已脱敏**：`LOG_PROMPT_BODY=false`（生产环境不记录完整prompt）
- [ ] **日志轮转已配置**：防止日志文件过大
- [ ] **错误日志已监控**：设置告警监控错误日志
- [ ] **用量统计正常**：`usage_daily` 和 `usage_monthly` 表正常更新

## 🔄 高可用与容错

- [ ] **Key池熔断已配置**：`CIRCUIT_BREAKER_FAILURE_THRESHOLD` 和 `CIRCUIT_BREAKER_COOLDOWN_SECONDS` 已设置
- [ ] **多个上游Key已配置**：至少配置2个上游Key，支持故障切换
- [ ] **数据库连接池已配置**：`pool_size=10`，`max_overflow=20`
- [ ] **Redis连接正常**：Redis健康检查通过

## 🌐 网络与防火墙

- [ ] **防火墙规则已设置**：只开放必要端口（80, 443）
- [ ] **内部服务不暴露**：PostgreSQL、Redis 不对外暴露端口（或使用防火墙限制）
- [ ] **HTTPS强制启用**：HTTP请求自动重定向到HTTPS
- [ ] **CORS已配置**：生产环境限制具体域名，不使用 `allow_origins=["*"]`

## 💾 数据安全

- [ ] **数据库备份已配置**：定期备份PostgreSQL数据
- [ ] **备份加密**：数据库备份文件已加密存储
- [ ] **数据保留策略**：设置审计日志的保留期限
- [ ] **敏感数据加密**：上游API Key在数据库中已加密

## 🔍 代码安全

- [ ] **依赖已更新**：所有Python依赖包已更新到最新安全版本
- [ ] **SQL注入防护**：使用SQLAlchemy ORM，避免原生SQL
- [ ] **XSS防护**：API响应已正确转义
- [ ] **错误信息已脱敏**：错误响应不包含敏感信息（如密钥、内部路径）

## 📈 性能与容量

- [ ] **负载测试已完成**：进行压力测试，确认系统能承受预期负载
- [ ] **资源监控已配置**：监控CPU、内存、磁盘使用率
- [ ] **数据库索引已优化**：关键查询字段已建立索引
- [ ] **Nginx配置已优化**：worker进程数、连接数已根据服务器配置调整

## 🚨 告警与响应

- [ ] **告警规则已配置**：设置关键指标告警（错误率、响应时间、资源使用）
- [ ] **告警通知已设置**：告警能及时通知到运维人员
- [ ] **应急预案已准备**：准备服务降级、故障恢复预案
- [ ] **监控仪表板已配置**：可实时查看系统状态

## 📝 文档与流程

- [ ] **部署文档已完善**：`DEPLOYMENT.md` 包含完整部署步骤
- [ ] **故障排查文档已准备**：`TROUBLESHOOTING.md` 包含常见问题解决方案
- [ ] **运维手册已准备**：包含日常维护、备份、恢复流程
- [ ] **变更记录已维护**：记录所有配置变更和版本更新

## ✅ 最终验证

- [ ] **功能测试通过**：所有核心功能（鉴权、限流、配额、流式响应）测试通过
- [ ] **安全测试通过**：进行安全扫描，无高危漏洞
- [ ] **性能测试通过**：响应时间、吞吐量满足要求
- [ ] **灾难恢复测试**：测试数据库恢复、服务重启流程

## 🔗 相关资源

- [部署指南](DEPLOYMENT.md)
- [故障排查](TROUBLESHOOTING.md)
- [快速开始](QUICK_START.md)

---

**注意**：此清单应在每次部署前检查，建议保存检查记录。
